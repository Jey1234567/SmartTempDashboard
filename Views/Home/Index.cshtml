@{
    ViewData["Title"] = "Home Page";
}

<style>
    
    .temp-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(to right, #00c6ff, #0072ff);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        margin-bottom: 1rem;

    }

    .temp-value span {
        font-weight: bold;
        font-size: 1.6rem;
    }



</style>

<div class="temp-header">
    <h2>🌡️ Live Graph</h2>
    <h2 class="temp-value" >Aktuelle Temperatur: <span id="liveTemp">-- °C</span></h2>
</div>

<canvas id="TemperatureChart" width="800" height="400"></canvas>
<!--Use Chartjs and SignalR for dynamic graph-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.onload= function () {
    var suhuData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));

     var latest = suhuData.slice(-30); // get last 30 entries
     var labels = latest.map(x => new Date(x.Timestamp).toLocaleTimeString());
     var values = latest.map(x => x.Temp);

    var ctx = document.getElementById('TemperatureChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, "rgba(75,192,192,1)");
    gradient.addColorStop(1, "rgba(75,192,192,0)");
    window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels, // empty initially
            datasets: [{
                label: 'Temperature (°C)',
                data: values,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: gradient,
                fill: false,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                     display: true,
                     text: 'Temperature (°C)'
                    }
                }
            }
        }
    });

    // Connect to SignalR Hub
        const connection = new signalR.HubConnectionBuilder()
        .withUrl("/charthub")
        .build();

    connection.on("ReceiveTemperature", function (temp) {
        

        //Update temperature text
        document.getElementById("liveTemp").innerText = `${temp.temp} °C`;

        //Convert timestamp
        var timestamp=new Date(temp.timestamp).toLocaleTimeString();
        // Update your chart dynamically here
        addDataToChart(timestamp, temp.temp);
    });

    connection.start();

    function addDataToChart(timestamp, temperature) {
     
        
        myChart.data.labels.push(timestamp);
        myChart.data.datasets[0].data.push(temperature);
        
        if (myChart.data.labels.length > 30) {
            myChart.data.labels.shift();
            myChart.data.datasets[0].data.shift();
        }

        myChart.update();
    }

    }

</script>

